package main

import (
	"bufio"
	"fmt"
	"log"
	"net/http"
	"os"
	"time"

	"github.com/dhaef/job-scraper/internal/domain"
)

func main() {
	outFile, err := os.OpenFile("input.txt", os.O_RDWR|os.O_CREATE|os.O_APPEND, 0o644)
	if err != nil {
		log.Fatal(err)
	}
	defer outFile.Close()

	c := domain.Config{
		Client: &http.Client{
			Timeout: 30 * time.Second,
		},
		Seen:        map[string]bool{},
		InputFile:   outFile,
		InputWriter: bufio.NewWriter(outFile),
		URLs:        map[string]bool{},
	}

	seen, urls, err := c.LoadSeenURLs()
	if err != nil {
		log.Fatal(err)
	}
	c.Seen = seen
	c.URLs = urls

	f, err := os.Open("pentest-test.txt")
	if err != nil {
		log.Fatal(err)
	}
	defer f.Close()

	scanner := bufio.NewScanner(f)

	for scanner.Scan() {
		url := fmt.Sprintf("https://%s", scanner.Text())
		fmt.Println("working on ", url)

		err := c.ValidateURL(url)
		if err != nil {
			if err.Error() == "GOT 406" {
				log.Fatalf("got 406 at %s", url)
			}

			fmt.Println("failed to test url", url)
			continue
		}

		time.Sleep(500 * time.Millisecond)
	}

	if err := scanner.Err(); err != nil {
		fmt.Println(err.Error())
	}

	c.InputWriter.Flush()
}
